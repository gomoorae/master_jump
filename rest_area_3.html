<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="version" content="1.0.1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Î¨¥Ìòº ÎπÑÎèô: ÏµúÏ¢Ö Í∞ÅÏÑ± (ÏôÑÏÑ±Î≥∏)</title>
    
    <!-- PWA Î©îÌÉÄ ÌÉúÍ∑∏ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <style>
        @font-face {font-family: 'Dokdo'; src: url('assets/common/Dokdo-Regular.ttf') format('truetype'); font-weight: normal; font-style: normal; }
        body { 
            margin: 0; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            width: 100vw;
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* 16:9 ÎπÑÏú® Ïú†ÏßÄ Ïª®ÌÖåÏù¥ÎÑà */
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 56.25vw; /* 16:9 */
            max-height: 100vh;
            max-width: 177.78vh; /* 16:9 */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        
        canvas { 
            background: #0a0a0a; 
            border: 5px solid #5d4037; 
            cursor: pointer;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        
        #cutsceneVideo { 
            position: absolute; 
            display: none; 
            object-fit: cover;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        
        /* ÏÑ∏Î°ú Î™®Îìú ÏïàÎÇ¥ Î†àÏù¥Ïñ¥ */
        #rotateOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: #fff;
            font-family: 'Dokdo', cursive;
        }
        
        #rotateIcon {
            font-size: 120px;
            margin-bottom: 30px;
            animation: rotateAnim 2s ease-in-out infinite;
        }
        
        #rotateText {
            font-size: 60px;
            color: #00ffcc;
            text-shadow: 0 0 20px #00ffcc;
        }
        
        @keyframes rotateAnim {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }
        
        @media (orientation: portrait) {
            #rotateOverlay {
                display: flex !important;
            }
        }
        
        /* Îí§Î°úÍ∞ÄÍ∏∞ ÌôïÏù∏ ÌåùÏóÖ */
        #backConfirmOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: 'Dokdo', cursive;
        }
        
        #backConfirmOverlay.show {
            display: flex;
        }
        
        #backConfirmBox {
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            border: 5px solid #8b6914;
            border-radius: 20px;
            padding: 50px 60px;
            text-align: center;
            box-shadow: 0 0 40px rgba(139, 105, 20, 0.5);
        }
        
        #backConfirmMessage {
            color: #fff;
            font-size: 70px;
            margin-bottom: 50px;
            text-shadow: 0 0 20px #fff;
        }
        
        #backConfirmButtons {
            display: flex;
            gap: 30px;
            justify-content: center;
        }
        
        .backConfirmBtn {
            padding: 20px 50px;
            font-size: 50px;
            border: 3px solid;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Dokdo', cursive;
            background: rgba(0, 0, 0, 0.5);
        }
        
        #continueBtn {
            color: #ffcc00;
            border-color: #ffcc00;
        }
        
        #continueBtn:hover {
            background: #ffcc00;
            color: #000;
            transform: scale(1.05);
            box-shadow: 0 0 30px #ffcc00;
        }
        
        #exitBtn {
            color: #ff4444;
            border-color: #ff4444;
        }
        
        #exitBtn:hover {
            background: #ff4444;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 30px #ff4444;
        }
    </style>
</head>
<body>
    <!-- ÏÑ∏Î°ú Î™®Îìú ÏïàÎÇ¥ Î†àÏù¥Ïñ¥ -->
    <div id="rotateOverlay">
        <div id="rotateIcon">üì±‚ûúüéÆ</div>
        <div id="rotateText">Í∏∞Í∏∞Î•º Í∞ÄÎ°úÎ°ú ÎèåÎ†§Ï£ºÏÑ∏Ïöî</div>
    </div>
    
    <!-- Îí§Î°úÍ∞ÄÍ∏∞ ÌôïÏù∏ ÌåùÏóÖ -->
    <div id="backConfirmOverlay">
        <div id="backConfirmBox">
            <div id="backConfirmMessage">Í≤åÏûÑÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?</div>
            <div id="backConfirmButtons">
                <button id="continueBtn" class="backConfirmBtn">Í≥ÑÏÜçÌïòÍ∏∞</button>
                <button id="exitBtn" class="backConfirmBtn">ÎÇòÍ∞ÄÍ∏∞</button>
            </div>
        </div>
    </div>
    
    <div id="gameContainer">
        <video id="cutsceneVideo"></video>
        <canvas id="restCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('restCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('cutsceneVideo');
        canvas.width = 1600; canvas.height = 900;

        // 1. ÏóêÏÖã Î∞è ÏÉÅÌÉú Í¥ÄÎ¶¨
        const imgs = {
            introBGs: [new Image(), new Image(), new Image()],
            rewardBG: new Image(),
            resultBG: new Image()
        };

        // Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú ÏÑ§Ï†ï
        imgs.introBGs[0].src = 'assets/rest_stage_3/intro_bg1.png';
        imgs.introBGs[1].src = 'assets/rest_stage_3/intro_bg2.png';
        imgs.introBGs[2].src = 'assets/rest_stage_3/intro_bg3.png';
        imgs.rewardBG.src = 'assets/rest_stage_3/reward_bg.png';
        imgs.resultBG.src = 'assets/rest_stage_3/result_bg.png';

        // ÎπÑÎîîÏò§ Í≤ΩÎ°ú ÏÑ§Ï†ï
        const VIDEO_PATH = {
            INTRO: 'assets/rest_stage_3/cutscene.mp4',
            REWARD: 'assets/rest_stage_3/cutscene_reward.mp4' // ‚òÖ ÏÉàÎ°ú Ï§ÄÎπÑÌïú Ïª∑Ïã† Í≤ΩÎ°ú
        };

        let scene = 'INTRO'; // INTRO, VIDEO_INTRO, REWARD_TALK, VIDEO_REWARD, RESULT
        let dialogueIndex = 0;
        let resultMessage = "";

        const introTalk = [
            "ÎÇúÍ¥ÄÏùÑ ÎèåÌååÌïòÏûê, ÏÑ∏Î≤àÏß∏ Î¨¥Ìòº ÎπÑÎèôÏù¥ ÎÇòÏôîÎã§.",
            "Î¨¥ÌòºÏùò ÏõêÏ†ïÏù¥ ÌóàÍ≥µÏóêÏÑú ÎπõÎÇòÍ≥† ÏûàÎã§.",
            "Í∞ÄÍπåÏù¥ Îã§Í∞ÄÍ∞ÄÏûê Î¨¥ÌòºÏùò ÏõêÏ†ïÏù¥ Í≥µÎ™ÖÌïòÍ∏∞ ÏãúÏûëÌñàÎã§."
        ];

        const rewardTalk = [
            "ÎßàÏßÄÎßâ Î¨¥ÌòºÏùò ÏõêÏ†ïÏù¥ Ìù°ÏàòÎêòÏóàÎã§.",
            "Î™®Îì† Î¨¥ÌòºÏùò ÏõêÏ†ïÏù¥ ÌïòÎÇòÎ°ú Ìï©Ï≥êÏßÄÎ©∞, ÎÇ¥Î∂ÄÏóêÏÑú Î¨¥ÌòºÏùò ÌûòÏù¥ ÎäêÍª¥ÏßÑÎã§."
        ];

        // 2. ÌÅ¥Î¶≠ Î∞è ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ï†úÏñ¥
        function handlePointerDown(e) {
            // ‚òÖ Ï¢åÌëú Î≥ÄÌôò Ï∂îÍ∞Ä (ÌïÑÏöî Ïãú ÏÇ¨Ïö©)
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            if (scene === 'INTRO') {
                dialogueIndex++;
                if (dialogueIndex >= introTalk.length) {
                    playVideo('VIDEO_INTRO', VIDEO_PATH.INTRO); // Ïù∏Ìä∏Î°ú ÏòÅÏÉÅ Ïû¨ÏÉù
                }
            } else if (scene === 'REWARD_TALK') {
                dialogueIndex++;
                if (dialogueIndex >= rewardTalk.length) {
                    playVideo('VIDEO_REWARD', VIDEO_PATH.REWARD); // ‚òÖ Î≥¥ÏÉÅ Ïª∑Ïã† Ïû¨ÏÉù
                }
            } else if (scene === 'RESULT') {
                window.location.href = 'stage_final.html';
            }
        }
        
        canvas.addEventListener('mousedown', handlePointerDown);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handlePointerDown(e);
        });

        // ÎπÑÎîîÏò§ Ïû¨ÏÉù Í≥µÌÜµ Ìï®Ïàò
        function playVideo(nextScene, src) {
            scene = nextScene;
            video.src = src;
            video.style.display = 'block';
            video.play();
        }

        // ÎπÑÎîîÏò§ Ï¢ÖÎ£å Ïãú Î°úÏßÅ
        video.onended = () => {
            video.style.display = 'none';
            if (scene === 'VIDEO_INTRO') {
                scene = 'REWARD_TALK';
                dialogueIndex = 0;
            } else if (scene === 'VIDEO_REWARD') {
                // Î≥¥ÏÉÅ Ïª∑Ïã†Ïù¥ ÎÅùÎÇú ÌõÑ Î≥¥ÏÉÅ Ï†ÅÏö© Î∞è Í≤∞Í≥ºÏ∞Ω Ïù¥Îèô
                applyFinalReward();
                scene = 'RESULT';
            }
        };

        function applyFinalReward() {
            localStorage.setItem('maxJingi', 15);
            localStorage.setItem('jingiRecoverThreshold', 30);
            resultMessage = "Î¨¥ÌòºÏùò ÏßÑÍ∏∞Î•º ÏôÑÎ≤ΩÌûà Ï≤¥ÎìùÌïòÏó¨ ÏßÑÍ∏∞Ïùò Í∑∏Î¶áÍ≥º ÌöåÎ≥µ ÏÜçÎèÑÍ∞Ä ÏµúÍ≥†ÏπòÏóê Îã¨ÌñàÎã§.";
        }

        // 3. Î†åÎçîÎßÅ Î£®ÌîÑ
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (scene === 'INTRO') {
                let curBG = imgs.introBGs[dialogueIndex];
                if (curBG && curBG.complete) ctx.drawImage(curBG, 0, 0, 1600, 900);
                drawDialogue(introTalk[dialogueIndex]);

            } else if (scene === 'REWARD_TALK') {
                if (imgs.rewardBG.complete) ctx.drawImage(imgs.rewardBG, 0, 0, 1600, 900);
                drawDialogue(rewardTalk[dialogueIndex]);

            } else if (scene === 'RESULT') {
                if (imgs.resultBG.complete) ctx.drawImage(imgs.resultBG, 0, 0, 1600, 900);
                drawDialogue(resultMessage + "");
            }

            requestAnimationFrame(draw);
        }

        function drawDialogue(text) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(100, 700, 1400, 150);            
            ctx.fillStyle = 'white'; ctx.font = '50px "Dokdo"'; ctx.textAlign = 'left';
            const lines = text.split('\n');
            lines.forEach((line, i) => {
                ctx.fillText(line, 150, 770 + (i * 55));
            });
            ctx.font = '20px Arial'; ctx.textAlign = 'right';
            ctx.fillText("‚ñ∂", 1450, 830);
        }

        draw();
        
        // ===== PWA ÌôîÎ©¥ Î∞©Ìñ• Ï†úÏñ¥ =====
        async function lockOrientation() {
            try {
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                }
            } catch (error) {
                console.warn('[PWA] ÌôîÎ©¥ Î∞©Ìñ• Í≥†Ï†ï Ïã§Ìå®:', error);
            }
        }
        
        lockOrientation();
        
        const rotateOverlay = document.getElementById('rotateOverlay');
        function checkOrientation() {
            const isPortrait = window.innerHeight > window.innerWidth;
            rotateOverlay.style.display = isPortrait ? 'flex' : 'none';
        }
        
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', () => {
            checkOrientation();
            lockOrientation();
        });
        checkOrientation();
        
        // ===== ÌïòÎìúÏõ®Ïñ¥ Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº Í∞êÏßÄ Î∞è Î∞©ÏßÄ =====
        
        const backConfirmOverlay = document.getElementById('backConfirmOverlay');
        const continueBtn = document.getElementById('continueBtn');
        const exitBtn = document.getElementById('exitBtn');
        let isBackConfirmShowing = false;
        
        history.pushState({ page: 'game' }, '', location.href);
        
        window.addEventListener('popstate', (event) => {
            if (!isBackConfirmShowing) {
                history.pushState({ page: 'game' }, '', location.href);
                isBackConfirmShowing = true;
                backConfirmOverlay.classList.add('show');
            }
        });
        
        function handleContinue() {
            backConfirmOverlay.classList.remove('show');
            isBackConfirmShowing = false;
        }
        
        continueBtn.addEventListener('click', handleContinue);
        continueBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            handleContinue();
        });
        
        function handleExit() {
            backConfirmOverlay.classList.remove('show');
            isBackConfirmShowing = false;
            history.go(-1);
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 10);
        }
        
        exitBtn.addEventListener('click', handleExit);
        exitBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            handleExit();
        });
    </script>
</body>
</html>