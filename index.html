<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¬´í˜¼ ë¹„ë™: ì‹œë ¨ì˜ ì‹œì‘</title>
    
    <!-- PWA ë©”íƒ€ íƒœê·¸ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ë¬´í˜¼ ë¹„ë™">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="ëª¨ë“  ë‚œê´€ì„ ê·¹ë³µí•œ ìë§Œì´ ë¬´í˜¼ì„ ì–»ì„ ê²ƒì´ë‹¤">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- ì•„ì´ì½˜ ì„¤ì • -->
    <link rel="icon" type="image/png" href="assets/common/right_out.png">
    <link rel="apple-touch-icon" href="assets/common/right_out.png">
    <style>
        @font-face {font-family: 'Dokdo'; src: url('assets/common/Dokdo-Regular.ttf') format('truetype'); font-weight: normal; font-style: normal; }
        body { 
            margin: 0; 
            background: #000; 
            overflow: hidden; 
            font-family: 'Dokdo', cursive;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* 16:9 ë¹„ìœ¨ ìœ ì§€ + ìë™ ìŠ¤ì¼€ì¼ë§ ë˜í¼ */
        #gameWrapper {
            position: relative;
            width: 100vw;
            height: 56.25vw; /* 16:9 ë¹„ìœ¨ (9/16 = 56.25%) */
            max-height: 100vh;
            max-width: 177.78vh; /* 16:9 ë¹„ìœ¨ (16/9 = 177.78%) */
            background: #000;
        }
        
        /* ê³µí†µ ì „ì²´ í™”ë©´ ì„¤ì • */
        .screen { 
            width: 1600px; 
            height: 900px; 
            position: absolute; 
            left: 0; 
            top: 0; 
            transform-origin: top left;
            display: none;
        }
        .active { display: block; }

        /* 1. íƒ€ì´í‹€ ë©”ë‰´ í™”ë©´ */
        #titleMenu { background: url('assets/title/bg_title.png') no-repeat center/cover; }
        
        #startBtn { 
            position: absolute;
            left: 25%;
            top: 35%;
            transform: translateX(-50%);
            width: 650px;
            font-size: 80px;
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
            background: rgba(0,0,0,0.5);
            border: none;
            color: #ffffff;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
        }
        #startBtn:hover { 
            transform: translateX(-50%) scale(1.1); 
            color: #fc2828; 
        }

        /* 2. ì»·ì‹  í™”ë©´ */
        #cutsceneVideo { background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* [3] ë©”ì‹œì§€ ì˜¤ë²„ë ˆì´ (ì„œì±… ë°°ê²½ í˜•íƒœ) */
        #msgOverlay { background: rgba(0,0,0,0.6); cursor: pointer; } 
        
        .msg-box { 
            position: absolute; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%);
            /* â˜… ì„œì±… ì´ë¯¸ì§€ ì„¤ì • */
            width: 1200px; 
            height: 850px; 
            background: url('assets/title/scroll_bg.png') no-repeat center/contain; 
            /* ì´ë¯¸ì§€ ì•ˆìª½ìœ¼ë¡œ í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ì˜¤ë„ë¡ ì—¬ë°± ì¡°ì • */
            padding: 100px 180px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .msg-text { 
            /* â˜… ì„œì±…(ì¢…ì´) ìœ„ì— ì–´ìš¸ë¦¬ëŠ” ì§™ì€ ê°ˆìƒ‰ ê³„ì—´ ê¸€ììƒ‰ */
            color: #2d1b0d; 
            font-size: 50px; 
            line-height: 1.5; 
            white-space: pre-wrap; 
            text-align: center;
            word-break: keep-all;
        }

        .next-hint { 
            position: absolute; 
            bottom: 180px; 
            right: 220px; 
            color: #5d4037; 
            font-size: 30px; 
            animation: blink 1s infinite; 
        }
        
        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        
        /* ì„¸ë¡œ ëª¨ë“œ ì•ˆë‚´ ë ˆì´ì–´ */
        #rotateOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: #fff;
            font-family: 'Dokdo', cursive;
        }
        
        #rotateOverlay.show {
            display: flex;
        }
        
        #rotateIcon {
            font-size: 120px;
            margin-bottom: 30px;
            animation: rotateAnim 2s ease-in-out infinite;
        }
        
        #rotateText {
            font-size: 60px;
            color: #00ffcc;
            text-shadow: 0 0 20px #00ffcc;
        }
        
        @keyframes rotateAnim {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }
        
        /* ê°€ë¡œ ëª¨ë“œì—ì„œë§Œ ê²Œì„ í‘œì‹œ */
        @media (orientation: portrait) {
            #rotateOverlay {
                display: flex !important;
            }
        }
    </style>
</head>
<body>
    <!-- ì„¸ë¡œ ëª¨ë“œ ì•ˆë‚´ ë ˆì´ì–´ -->
    <div id="rotateOverlay">
        <div id="rotateIcon">ğŸ“±âœğŸ®</div>
        <div id="rotateText">ê¸°ê¸°ë¥¼ ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”</div>
    </div>
    
    <div id="gameWrapper">
        <div id="titleMenu" class="screen active">
            <div id="startBtn">ë¬´í˜¼ ë¹„ë™ì— ë“¤ì–´ê°„ë‹¤</div>
        </div>

        <div id="cutsceneVideo" class="screen">
            <video id="introVideo">
                <source src="assets/title/cutscene_intro.mp4" type="video/mp4">
            </video>
        </div>

        <div id="msgOverlay" class="screen">
            <div class="msg-box">
                <div id="msgContent" class="msg-text"></div>
                <div class="next-hint">->></div>
            </div>
        </div>
    </div>

    <script>
        // ë°˜ì‘í˜• ìŠ¤ì¼€ì¼ë§ í•¨ìˆ˜
        function scaleGame() {
            const wrapper = document.getElementById('gameWrapper');
            const screens = document.querySelectorAll('.screen');
            const baseWidth = 1600;
            const baseHeight = 900;
            
            const scaleX = wrapper.offsetWidth / baseWidth;
            const scaleY = wrapper.offsetHeight / baseHeight;
            const scale = Math.min(scaleX, scaleY);
            
            screens.forEach(screen => {
                screen.style.transform = `scale(${scale})`;
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ë° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìŠ¤ì¼€ì¼ë§ ì ìš©
        window.addEventListener('load', scaleGame);
        window.addEventListener('resize', scaleGame);
        
    
        const titleMenu = document.getElementById('titleMenu');
        const cutsceneScreen = document.getElementById('cutsceneVideo');
        const introVideo = document.getElementById('introVideo');
        const msgOverlay = document.getElementById('msgOverlay');
        const msgContent = document.getElementById('msgContent');

        const introMessages = [
            "[ë¬´í˜¼ ë¹„ë™]\nëª¨ë“  ë‚œê´€ì„ ê·¹ë³µí•œ ìë§Œì´ ë¬´í˜¼ì„ ì–»ì„ ê²ƒì´ë‹¤.",
            "í™”ë©´ì„ ëˆ„ë¥´ë©´ ìƒìŠ¹, ë–¼ë©´ í•˜ê°• í•œë‹¤.",
            "ë°”ë‹¥ì˜ í•¨ì •ê³¼ ë§‰í˜€ìˆëŠ” ì²œì¥ ì‚¬ì´ì—ì„œ,\në‚ ì•„ì˜¤ëŠ” ë¬´ê¸°ë¥¼ í”¼í•˜ì—¬ ë‚œê´€ì„ ëŒíŒŒí•˜ì—¬ì•¼ í•œë‹¤.",
            "í™”ë©´ì„ ëˆ„ë¥´ë©´ ìƒìŠ¹í•˜ê³  ë–¼ë©´ í•˜ê°•í•˜ë©°,\nì§„ê¸°ë¥¼ ì†Œë¹„í•˜ì—¬ ìœ„í—˜ì„ ìë™ íšŒë¹„í•œë‹¤.",
            "ì§„ê¸° í‘œì‹ ë°‘ì˜ í™©ìƒ‰ í‘œì‹ì´\nì§„ê¸°ì˜ ì´ëŸ‰ê³¼ ê°™ì€ ìœ„ì¹˜ì— ë„ë‹¬í•˜ë©´ ë‚œê´€ì´ ëë‚œë‹¤.",
            "ì‹œë ¨ì„ ê·¹ë³µí•˜ê³  ë¬´í˜¼ì„ ì–»ëŠ”ê²ƒì€\nê·¸ëŒ€ì˜ ì†ì— ë‹¬ë ¤ìˆë‹¤."
        ];

        let currentMsgIndex = 0;

        function initNewGame() {
            localStorage.setItem('maxJingi', 8);
            localStorage.setItem('jingiRecoverThreshold', 180);
        }

        // í„°ì¹˜ ë° í´ë¦­ ëª¨ë‘ ì§€ì›í•˜ëŠ” í•¨ìˆ˜
        function addTouchAndClick(element, handler) {
            element.addEventListener('click', handler);
            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handler(e);
            });
        }

        addTouchAndClick(document.getElementById('startBtn'), () => {
            initNewGame();
            titleMenu.classList.remove('active');
            cutsceneScreen.classList.add('active');
            introVideo.play();
        });

        introVideo.onended = () => {
            cutsceneScreen.classList.remove('active');
            msgOverlay.classList.add('active');
            showNextMessage();
        };

        function showNextMessage() {
            if (currentMsgIndex < introMessages.length) {
                msgContent.innerText = introMessages[currentMsgIndex];
                currentMsgIndex++;
            } else {
                window.location.href = 'stage_1.html';
            }
        }

        addTouchAndClick(msgOverlay, showNextMessage);
        
        // ===== PWA ê¸°ëŠ¥ =====
        
        // 1. ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('[PWA] Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);
                    })
                    .catch((error) => {
                        console.warn('[PWA] Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
                    });
            });
        }
        
        // 2. í™”ë©´ ë°©í–¥ ê°•ì œ ê³ ì • (ê°€ë¡œ ëª¨ë“œ)
        async function lockOrientation() {
            try {
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                    console.log('[PWA] í™”ë©´ ë°©í–¥ ê³ ì •: ê°€ë¡œ ëª¨ë“œ');
                }
            } catch (error) {
                console.warn('[PWA] í™”ë©´ ë°©í–¥ ê³ ì • ì‹¤íŒ¨:', error);
                // CSS ë¯¸ë””ì–´ ì¿¼ë¦¬ë¡œ í´ë°± ì²˜ë¦¬
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°©í–¥ ê³ ì • ì‹œë„
        document.addEventListener('DOMContentLoaded', () => {
            lockOrientation();
        });
        
        // ì „ì²´ í™”ë©´ ëª¨ë“œ ì§„ì… ì‹œ ë°©í–¥ ê³ ì • ì¬ì‹œë„
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                lockOrientation();
            }
        });
        
        // 3. ì„¸ë¡œ ëª¨ë“œ ê°ì§€ ë° ì•ˆë‚´ ë ˆì´ì–´ í‘œì‹œ
        const rotateOverlay = document.getElementById('rotateOverlay');
        
        function checkOrientation() {
            const isPortrait = window.innerHeight > window.innerWidth;
            if (isPortrait) {
                rotateOverlay.classList.add('show');
            } else {
                rotateOverlay.classList.remove('show');
            }
        }
        
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', checkOrientation);
        checkOrientation(); // ì´ˆê¸° í™•ì¸
        
        // 4. PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ (ì„ íƒì‚¬í•­)
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('[PWA] ì„¤ì¹˜ ê°€ëŠ¥');
        });
    </script>
</body>
</html>