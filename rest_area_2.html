<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¬´í˜¼ ë¹„ë™: íœ´ì‹ê³¼ ê¹¨ë‹¬ìŒ (UI í†µì¼íŒ)</title>
    
    <!-- PWA ë©”íƒ€ íƒœê·¸ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <style>
        @font-face {font-family: 'Dokdo'; src: url('assets/common/Dokdo-Regular.ttf') format('truetype'); font-weight: normal; font-style: normal; }
        body { 
            margin: 0; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            width: 100vw;
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* 16:9 ë¹„ìœ¨ ìœ ì§€ ì»¨í…Œì´ë„ˆ */
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 56.25vw; /* 16:9 */
            max-height: 100vh;
            max-width: 177.78vh; /* 16:9 */
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }
        
        canvas { 
            background: #0a0a0a; 
            border: 5px solid #5d4037; 
            cursor: pointer;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        
        #cutsceneVideo { 
            position: absolute; 
            display: none; 
            object-fit: cover;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        
        /* ì„¸ë¡œ ëª¨ë“œ ì•ˆë‚´ ë ˆì´ì–´ */
        #rotateOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: #fff;
            font-family: 'Dokdo', cursive;
        }
        
        #rotateIcon {
            font-size: 120px;
            margin-bottom: 30px;
            animation: rotateAnim 2s ease-in-out infinite;
        }
        
        #rotateText {
            font-size: 60px;
            color: #00ffcc;
            text-shadow: 0 0 20px #00ffcc;
        }
        
        @keyframes rotateAnim {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }
        
        @media (orientation: portrait) {
            #rotateOverlay {
                display: flex !important;
            }
        }
        
        /* ë’¤ë¡œê°€ê¸° í™•ì¸ íŒì—… */
        #backConfirmOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: 'Dokdo', cursive;
        }
        
        #backConfirmOverlay.show {
            display: flex;
        }
        
        #backConfirmBox {
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            border: 5px solid #8b6914;
            border-radius: 20px;
            padding: 50px 60px;
            text-align: center;
            box-shadow: 0 0 40px rgba(139, 105, 20, 0.5);
        }
        
        #backConfirmMessage {
            color: #fff;
            font-size: 70px;
            margin-bottom: 50px;
            text-shadow: 0 0 20px #fff;
        }
        
        #backConfirmButtons {
            display: flex;
            gap: 30px;
            justify-content: center;
        }
        
        .backConfirmBtn {
            padding: 20px 50px;
            font-size: 50px;
            border: 3px solid;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Dokdo', cursive;
            background: rgba(0, 0, 0, 0.5);
        }
        
        #continueBtn {
            color: #ffcc00;
            border-color: #ffcc00;
        }
        
        #continueBtn:hover {
            background: #ffcc00;
            color: #000;
            transform: scale(1.05);
            box-shadow: 0 0 30px #ffcc00;
        }
        
        #exitBtn {
            color: #ff4444;
            border-color: #ff4444;
        }
        
        #exitBtn:hover {
            background: #ff4444;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 30px #ff4444;
        }
    </style>
</head>
<body>
    <!-- ì„¸ë¡œ ëª¨ë“œ ì•ˆë‚´ ë ˆì´ì–´ -->
    <div id="rotateOverlay">
        <div id="rotateIcon">ğŸ“±âœğŸ®</div>
        <div id="rotateText">ê¸°ê¸°ë¥¼ ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”</div>
    </div>
    
    <!-- ë’¤ë¡œê°€ê¸° í™•ì¸ íŒì—… -->
    <div id="backConfirmOverlay">
        <div id="backConfirmBox">
            <div id="backConfirmMessage">ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div id="backConfirmButtons">
                <button id="continueBtn" class="backConfirmBtn">ê³„ì†í•˜ê¸°</button>
                <button id="exitBtn" class="backConfirmBtn">ë‚˜ê°€ê¸°</button>
            </div>
        </div>
    </div>
    
    <div id="gameContainer">
        <video id="cutsceneVideo" src="assets/rest_stage_2/cutscene.mp4"></video>
        <canvas id="restCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('restCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('cutsceneVideo');
        canvas.width = 1600; canvas.height = 900;

        // 1. ì—ì…‹ ë° ìƒíƒœ ê´€ë¦¬
        const imgs = {
            introBGs: [new Image(), new Image(), new Image()],
            rewardBG: new Image(),
            resultBG: new Image()
        };

        imgs.introBGs[0].src = 'assets/rest_stage_2/intro_bg1.png';
        imgs.introBGs[1].src = 'assets/rest_stage_2/intro_bg2.png';
        imgs.introBGs[2].src = 'assets/rest_stage_2/intro_bg3.png';
        imgs.rewardBG.src = 'assets/rest_stage_2/reward_bg.png';
        imgs.resultBG.src = 'assets/rest_stage_2/result_bg.png';

        let scene = 'INTRO'; // INTRO, VIDEO, REWARD_TALK, CHOICE, RESULT
        let dialogueIndex = 0;
        let resultMessage = "";
        let mouseX = 0;
        let mouseY = 0;

        const introTalk = [
            "ë‚œê´€ì„ ëŒíŒŒí•˜ì, ë‘ë²ˆì§¸ ë¬´í˜¼ ë¹„ë™ì´ ë‚˜ì™”ë‹¤.",
            "ë¬´í˜¼ì˜ ì›ì •ì´ í—ˆê³µì—ì„œ ë¹›ë‚˜ê³  ìˆë‹¤.",
            "ê°€ê¹Œì´ ë‹¤ê°€ê°€ì ë¬´í˜¼ì˜ ì›ì •ì´ ê³µëª…í•˜ê¸° ì‹œì‘í–ˆë‹¤."
        ];

        const rewardTalk = [
            "ë‘ë²ˆì§¸ ë¬´í˜¼ì˜ ì›ì •ì´ í¡ìˆ˜ë˜ì—ˆë‹¤.",
            "ì§„ê¸°ì— ë³€í™”ê°€ ìƒê¸´ê±¸ ëŠë¼ê³ , ì°¨ë¶„íˆ ë‚´ë¶€ë¥¼ ê´€ì¡°í•´ ë³´ì•˜ë‹¤."
        ];

        // 2. ë§ˆìš°ìŠ¤ ë° í„°ì¹˜ ì´ë²¤íŠ¸
        function updatePointerPosition(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            // â˜… ì¤‘ìš”: ìŠ¤ì¼€ì¼ëœ canvas ì¢Œí‘œë¥¼ ì‹¤ì œ canvas ì¢Œí‘œë¡œ ë³€í™˜
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            mouseX = (clientX - rect.left) * scaleX;
            mouseY = (clientY - rect.top) * scaleY;
        }
        
        canvas.addEventListener('mousemove', updatePointerPosition);
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            updatePointerPosition(e);
        });

        function handlePointerDown(e) {
            updatePointerPosition(e);
            
            if (scene === 'INTRO') {
                dialogueIndex++;
                if (dialogueIndex >= introTalk.length) startVideo();
            } else if (scene === 'REWARD_TALK') {
                dialogueIndex++;
                if (dialogueIndex >= rewardTalk.length) scene = 'CHOICE';
            } else if (scene === 'CHOICE') {
                // ë²„íŠ¼ í´ë¦­ íŒì •
                if (mouseY >= 450 && mouseY <= 550) {
                    if (mouseX >= 400 && mouseX <= 750) selectReward('CAPACITY');
                    else if (mouseX >= 850 && mouseX <= 1200) selectReward('SPEED');
                }
            } else if (scene === 'RESULT') {
                window.location.href = 'stage_3.html';
            }
        }
        
        canvas.addEventListener('mousedown', handlePointerDown);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handlePointerDown(e);
        });

        function startVideo() {
            scene = 'VIDEO';
            video.style.display = 'block';
            video.play();
            video.onended = () => {
                video.style.display = 'none';
                scene = 'REWARD_TALK';
                dialogueIndex = 0;
            };
        }

        function selectReward(type) {
            let currentMax = parseInt(localStorage.getItem('maxJingi')) || 8;
            let currentSpeed = parseInt(localStorage.getItem('jingiRecoverThreshold')) || 180;

            if (type === 'CAPACITY') {
                localStorage.setItem('maxJingi', currentMax + 2);
                resultMessage = "ì§„ê¸°ì˜ ê·¸ë¦‡ì´ ë„“ì–´ì ¸ ìˆì—ˆë‹¤.";
            } else if (type === 'SPEED') {
                localStorage.setItem('jingiRecoverThreshold', Math.max(60, currentSpeed - 30));
                resultMessage = "ì§„ê¸°ì˜ ìˆœí™˜ì´ ë¹¨ë¼ì ¸ ìˆì—ˆë‹¤.";
            }
            scene = 'RESULT';
        }

        // 3. ë Œë”ë§ ë£¨í”„
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (scene === 'INTRO') {
                let curBG = imgs.introBGs[dialogueIndex];
                if (curBG && curBG.complete) ctx.drawImage(curBG, 0, 0, 1600, 900);
                drawDialogue(introTalk[dialogueIndex]);

            } else if (scene === 'REWARD_TALK' || scene === 'CHOICE') {
                if (imgs.rewardBG.complete) ctx.drawImage(imgs.rewardBG, 0, 0, 1600, 900);
                if (scene === 'REWARD_TALK') drawDialogue(rewardTalk[dialogueIndex]);
                else drawChoiceButtons();

            } else if (scene === 'RESULT') {
                if (imgs.resultBG.complete) ctx.drawImage(imgs.resultBG, 0, 0, 1600, 900);
                // â˜… ê²°ê³¼ ë©”ì‹œì§€ ì°½ì„ í•˜ë‹¨ ëŒ€í™”ì°½ ìœ„ì¹˜ë¡œ ì´ë™
                drawDialogue(resultMessage + "\n\n (ë‹¤ìŒ ë‚œê´€ìœ¼ë¡œ ì´ë™)");
            }

            requestAnimationFrame(draw);
        }

        // ê³µí†µ ëŒ€í™”ì°½ í•¨ìˆ˜
        function drawDialogue(text) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(100, 700, 1400, 150);            
            ctx.fillStyle = 'white'; ctx.font = '50px "Dokdo"'; ctx.textAlign = 'left';
            ctx.fillText(text, 150, 785);
            ctx.font = '20px Arial'; ctx.textAlign = 'right';
            ctx.fillText("â–¶", 1450, 830);
            ctx.lineWidth = 1;
        }

        // â˜… ë³´ìƒ ì„ íƒ ë²„íŠ¼ ê·¸ë¦¬ê¸° (ë§ˆìš°ìŠ¤ ì˜¤ë²„ íš¨ê³¼ ì¶”ê°€)
        function drawChoiceButtons() {
            ctx.fillStyle = 'white'; ctx.font = '80px "Dokdo"'; ctx.textAlign = 'center';
            ctx.fillText("ì§„ê¸°ë¥¼ ê´€ì¡°í•´ë³¸ ê²°ê³¼..", 800, 300);
            
            // ë²„íŠ¼ 1: ì§„ê¸° ì´ëŸ‰
            const isHover1 = (mouseX >= 400 && mouseX <= 750 && mouseY >= 450 && mouseY <= 550);
            // â˜… ë§ˆìš°ìŠ¤ê°€ ì˜¬ë¼ê°€ë©´ ì¡°ê¸ˆ ë” ì§„í•œ ë°˜íˆ¬ëª… ê²€ì •(0.8), í‰ì†Œì—” ì—°í•œ ë°˜íˆ¬ëª… ê²€ì •(0.5)
            ctx.fillStyle = isHover1 ? 'rgba(0, 0, 0, 0.8)' : 'rgba(0, 0, 0, 0.5)'; 
            ctx.fillRect(400, 450, 350, 100);            
                        
            ctx.fillStyle = isHover1 ? '#fc2828' : 'white'; 
            ctx.font = '40px "Dokdo"'; ctx.fillText("ì§„ê¸° ì´ëŸ‰ ì¦ê°€", 575, 510);
            
            // ë²„íŠ¼ 2: íšŒë³µ ì†ë„
            const isHover2 = (mouseX >= 850 && mouseX <= 1200 && mouseY >= 450 && mouseY <= 550);
            ctx.fillStyle = isHover2 ? 'rgba(0, 0, 0, 0.8)' : 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(850, 450, 350, 100);            
                   
            ctx.fillStyle = isHover2 ? '#fc2828' : 'white';
            ctx.font = '40px "Dokdo"'; ctx.fillText("ì§„ê¸° íšŒë³µ ì†ë„ ì¦ê°€", 1025, 510);
        }

        draw();
        
        // ===== PWA í™”ë©´ ë°©í–¥ ì œì–´ =====
        async function lockOrientation() {
            try {
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                }
            } catch (error) {
                console.warn('[PWA] í™”ë©´ ë°©í–¥ ê³ ì • ì‹¤íŒ¨:', error);
            }
        }
        
        lockOrientation();
        
        const rotateOverlay = document.getElementById('rotateOverlay');
        function checkOrientation() {
            const isPortrait = window.innerHeight > window.innerWidth;
            rotateOverlay.style.display = isPortrait ? 'flex' : 'none';
        }
        
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', () => {
            checkOrientation();
            lockOrientation();
        });
        checkOrientation();
        
        // ===== í•˜ë“œì›¨ì–´ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ê°ì§€ ë° ë°©ì§€ =====
        
        const backConfirmOverlay = document.getElementById('backConfirmOverlay');
        const continueBtn = document.getElementById('continueBtn');
        const exitBtn = document.getElementById('exitBtn');
        let isBackConfirmShowing = false;
        
        history.pushState({ page: 'game' }, '', location.href);
        
        window.addEventListener('popstate', (event) => {
            if (!isBackConfirmShowing) {
                history.pushState({ page: 'game' }, '', location.href);
                isBackConfirmShowing = true;
                backConfirmOverlay.classList.add('show');
            }
        });
        
        function handleContinue() {
            backConfirmOverlay.classList.remove('show');
            isBackConfirmShowing = false;
        }
        
        continueBtn.addEventListener('click', handleContinue);
        continueBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            handleContinue();
        });
        
        function handleExit() {
            backConfirmOverlay.classList.remove('show');
            isBackConfirmShowing = false;
            history.go(-1);
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 10);
        }
        
        exitBtn.addEventListener('click', handleExit);
        exitBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            handleExit();
        });
    </script>
</body>
</html>